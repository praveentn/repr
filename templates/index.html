<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Representation Engine v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        /* Enhanced styles for representations */
        .representation-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .representation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        /* Color-coded sections */
        .color-coded-facts { @apply bg-blue-50 border-l-4 border-blue-400 p-4 mb-3 rounded-r-lg; }
        .color-coded-assumptions { @apply bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-3 rounded-r-lg; }
        .color-coded-examples { @apply bg-green-50 border-l-4 border-green-400 p-4 mb-3 rounded-r-lg; }
        .color-coded-warnings { @apply bg-red-50 border-l-4 border-red-400 p-4 mb-3 rounded-r-lg; }
        
        /* Collapsible concepts */
        .collapsible-concept {
            @apply border border-gray-200 rounded-lg mb-3 overflow-hidden transition-all duration-300;
        }
        
        .concept-header {
            @apply bg-gray-50 p-4 cursor-pointer hover:bg-gray-100 transition-colors flex items-center justify-between;
        }
        
        .concept-content {
            @apply p-4 bg-white border-t border-gray-200;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .concept-content.expanded {
            max-height: 1000px;
        }
        
        /* Knowledge graph container */
        .knowledge-graph-container {
            @apply w-full border border-gray-300 rounded-lg bg-white;
            height: 500px;
            position: relative;
        }
        
        .knowledge-graph-container .vis-network {
            width: 100%;
            height: 100%;
        }
        
        /* Timeline container */
        .timeline-container {
            @apply w-full border border-gray-300 rounded-lg bg-white;
            height: 400px;
            position: relative;
        }
        
        .timeline-container .vis-timeline {
            width: 100%;
            height: 100%;
        }
        
        /* Loading states */
        .loading-spinner {
            @apply animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600;
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Cache indicator */
        .cache-indicator {
            @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium;
        }
        
        .cache-hit {
            @apply bg-green-100 text-green-800;
        }
        
        .cache-miss {
            @apply bg-blue-100 text-blue-800;
        }
        
        /* Enhanced button for regenerate */
        .regenerate-btn {
            @apply bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm transition-colors;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 via-white to-blue-50 min-h-screen">
    <div x-data="knowledgeApp()" x-init="init()" class="container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- Header -->
        <header class="text-center mb-12">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full mb-4">
                <i class="fas fa-brain text-white text-2xl"></i>
            </div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">
                Knowledge Representation Engine v2.0
            </h1>
            <p class="text-gray-600 text-lg">Transform information into multiple dynamic representations with intelligent caching</p>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Input Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-xl p-6 representation-card">
                    <h2 class="text-2xl font-semibold mb-6 flex items-center">
                        <i class="fas fa-keyboard text-blue-600 mr-3"></i>
                        Input
                    </h2>
                    
                    <!-- Query Input -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Your Query</label>
                        <textarea 
                            x-model="query" 
                            placeholder="Ask anything... e.g., 'Explain quantum computing' or 'How does machine learning work?'"
                            class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        ></textarea>
                    </div>
                    
                    <!-- Context Input -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Context (Optional)
                            <i class="fas fa-info-circle text-gray-400 ml-1" title="Additional background information"></i>
                        </label>
                        <textarea 
                            x-model="context" 
                            placeholder="Previous conversation, background info, your expertise level..."
                            class="w-full h-20 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        ></textarea>
                    </div>
                    
                    <!-- File Upload -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload File (Optional)</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-400 transition-colors cursor-pointer"
                             @click="$refs.fileInput.click()">
                            <i class="fas fa-cloud-upload-alt text-gray-400 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Click to upload JSON, TXT, or other files</p>
                            <input type="file" x-ref="fileInput" @change="handleFileUpload($event)" class="hidden" accept=".json,.txt,.md">
                        </div>
                    </div>
                    
                    <!-- Representation Mode Selector -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Representation Mode</label>
                        <div class="grid grid-cols-2 gap-2">
                            <template x-for="(mode, key) in representationModes" :key="key">
                                <button 
                                    @click="selectedMode = key"
                                    :class="selectedMode === key ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                    class="p-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center"
                                >
                                    <span x-text="mode.icon" class="mr-2"></span>
                                    <span x-text="mode.name"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Regenerate Option -->
                    <div class="mb-4" x-show="result && result.metadata && result.metadata.cache_info && result.metadata.cache_info.is_cached">
                        <label class="flex items-center">
                            <input type="checkbox" x-model="forceRegenerate" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            <span class="ml-2 text-sm text-gray-700">Regenerate (ignore cache)</span>
                        </label>
                    </div>
                    
                    <!-- Submit Button -->
                    <button 
                        @click="processQuery()"
                        :disabled="!query.trim() || loading"
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:shadow-lg transform hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                    >
                        <span x-show="!loading" class="flex items-center justify-center">
                            <i class="fas fa-magic mr-2"></i>
                            Generate Representation
                        </span>
                        <span x-show="loading" class="flex items-center justify-center">
                            <div class="loading-spinner mr-2"></div>
                            Processing...
                        </span>
                    </button>
                </div>
                
                <!-- Quick Examples -->
                <div class="mt-6 bg-white rounded-xl shadow-lg p-4">
                    <h3 class="font-semibold mb-3 text-gray-800">💡 Quick Examples</h3>
                    <div class="space-y-2">
                        <template x-for="example in quickExamples" :key="example.query">
                            <button 
                                @click="query = example.query; selectedMode = example.mode"
                                class="w-full text-left p-2 text-sm text-gray-600 hover:bg-blue-50 hover:text-blue-700 rounded transition-colors"
                                x-text="example.query"
                            ></button>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- Output Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-xl representation-card">
                    
                    <!-- Output Header -->
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h2 class="text-2xl font-semibold flex items-center">
                                <i class="fas fa-display text-blue-600 mr-3"></i>
                                <span x-text="result ? `${representationModes[result.mode]?.name} Representation` : 'Output'"></span>
                            </h2>
                            <div x-show="result" class="flex items-center space-x-3">
                                <!-- Cache Indicator -->
                                <div x-show="result && result.metadata && result.metadata.cache_info">
                                    <span x-show="result.metadata.cache_info.is_cached" class="cache-indicator cache-hit">
                                        <i class="fas fa-database mr-1"></i>
                                        Cached (<span x-text="result.metadata.cache_info.cache_age_hours?.toFixed(1)"></span>h old)
                                    </span>
                                    <span x-show="!result.metadata.cache_info.is_cached" class="cache-indicator cache-miss">
                                        <i class="fas fa-bolt mr-1"></i>
                                        Fresh
                                    </span>
                                </div>
                                
                                <span class="text-sm text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>
                                    <span x-text="result?.processing_time?.toFixed(2)"></span>s
                                </span>
                                <span class="text-sm text-gray-500">
                                    <i class="fas fa-coins mr-1"></i>
                                    <span x-text="result?.token_usage?.total_tokens"></span> tokens
                                </span>
                                <button @click="exportResult()" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-download"></i>
                                </button>
                                <!-- Regenerate button for cached results -->
                                <button x-show="result && result.metadata && result.metadata.cache_info && result.metadata.cache_info.is_cached" 
                                        @click="forceRegenerate = true; processQuery()" 
                                        class="regenerate-btn">
                                    <i class="fas fa-redo mr-1"></i>
                                    Regenerate
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Output Content -->
                    <div class="p-6 min-h-96">
                        
                        <!-- Loading State -->
                        <div x-show="loading" class="flex items-center justify-center h-64">
                            <div class="text-center">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-gray-600">Processing your request...</p>
                                <p class="text-sm text-gray-500 mt-2">Generating <span x-text="representationModes[selectedMode]?.name"></span> representation</p>
                            </div>
                        </div>
                        
                        <!-- Empty State -->
                        <div x-show="!loading && !result" class="flex items-center justify-center h-64 text-center">
                            <div>
                                <i class="fas fa-lightbulb text-6xl text-gray-300 mb-4"></i>
                                <h3 class="text-xl font-semibold text-gray-600 mb-2">Ready to Transform Knowledge</h3>
                                <p class="text-gray-500">Enter your query and select a representation mode to begin</p>
                            </div>
                        </div>
                        
                        <!-- Error State -->
                        <div x-show="error" class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                                <div>
                                    <h4 class="font-semibold text-red-800">Error Processing Request</h4>
                                    <p class="text-red-700" x-text="error"></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Results -->
                        <div x-show="result && !loading" class="fade-in">
                            
                            <!-- Plain Text -->
                            <div x-show="result?.mode === 'plain_text'" class="prose max-w-none">
                                <div x-html="result?.representation?.content?.formatted"></div>
                            </div>
                            
                            <!-- Color Coded -->
                            <div x-show="result?.mode === 'color_coded'">
                                <!-- Legend -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    <template x-for="(legend, type) in result?.representation?.content?.legend" :key="type">
                                        <div class="flex items-center p-3 rounded-lg border" :class="legend.bg_color">
                                            <span class="text-lg mr-2" x-text="legend.icon"></span>
                                            <div>
                                                <div class="font-medium text-sm" x-text="legend.label"></div>
                                                <div class="text-xs text-gray-600" x-text="legend.description"></div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Sections -->
                                <div class="space-y-4">
                                    <template x-for="(sections, type) in result?.representation?.content?.sections" :key="type">
                                        <div x-show="sections.length > 0">
                                            <template x-for="section in sections" :key="section">
                                                <div :class="`color-coded-${type}`">
                                                    <div class="flex items-start">
                                                        <span x-text="result?.representation?.content?.legend[type]?.icon" class="mr-3 mt-1 text-lg"></span>
                                                        <div>
                                                            <div class="font-medium text-sm mb-1" x-text="result?.representation?.content?.legend[type]?.label"></div>
                                                            <div x-text="section"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            
                            <!-- Collapsible Concepts -->
                            <div x-show="result?.mode === 'collapsible_concepts'" class="space-y-3">
                                <template x-for="concept in result?.representation?.content?.concepts" :key="concept.id">
                                    <div class="collapsible-concept" x-data="{ open: concept.expanded || false }">
                                        <div class="concept-header" @click="open = !open">
                                            <div class="flex items-center">
                                                <span class="text-lg mr-3" x-text="concept.icon"></span>
                                                <div>
                                                    <div class="font-medium" x-text="concept.title"></div>
                                                    <div class="text-sm text-gray-500" x-text="`Level ${concept.level} • ${concept.type}`"></div>
                                                </div>
                                            </div>
                                            <i class="fas fa-chevron-down transition-transform" :class="open && 'rotate-180'"></i>
                                        </div>
                                        <div x-show="open" x-transition class="concept-content" :class="open && 'expanded'">
                                            <p x-text="concept.content" class="mb-4"></p>
                                            
                                            <!-- Sub-concepts -->
                                            <div x-show="concept.children && concept.children.length > 0" class="space-y-2">
                                                <h4 class="font-medium text-sm text-gray-700 mb-2">Related Concepts:</h4>
                                                <template x-for="child in concept.children" :key="child.id">
                                                    <div class="bg-gray-50 p-3 rounded border-l-2 border-blue-300">
                                                        <div class="flex items-center mb-1">
                                                            <span class="text-sm mr-2" x-text="child.icon"></span>
                                                            <span class="font-medium text-sm" x-text="child.title"></span>
                                                        </div>
                                                        <p class="text-sm text-gray-600" x-text="child.content"></p>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Knowledge Graph -->
                            <div x-show="result?.mode === 'knowledge_graph'">
                                <div class="mb-4">
                                    <h4 class="font-medium mb-2">Interactive Knowledge Graph</h4>
                                    <p class="text-sm text-gray-600 mb-4">Click and drag nodes to explore relationships. Hover for details.</p>
                                </div>
                                <div id="knowledge-graph" class="knowledge-graph-container"></div>
                                <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div class="bg-blue-50 p-3 rounded">
                                        <div class="font-medium text-blue-800">Entities</div>
                                        <div class="text-2xl font-bold text-blue-600" x-text="result?.representation?.content?.stats?.node_count || 0"></div>
                                    </div>
                                    <div class="bg-green-50 p-3 rounded">
                                        <div class="font-medium text-green-800">Relationships</div>
                                        <div class="text-2xl font-bold text-green-600" x-text="result?.representation?.content?.stats?.edge_count || 0"></div>
                                    </div>
                                    <div class="bg-purple-50 p-3 rounded">
                                        <div class="font-medium text-purple-800">Complexity</div>
                                        <div class="text-lg font-bold text-purple-600 capitalize" x-text="result?.representation?.metadata?.complexity || 'N/A'"></div>
                                    </div>
                                    <div class="bg-yellow-50 p-3 rounded">
                                        <div class="font-medium text-yellow-800">Method</div>
                                        <div class="text-xs font-medium text-yellow-600">Enhanced NLP</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Timeline -->
                            <div x-show="result?.mode === 'timeline'">
                                <div class="mb-4">
                                    <h4 class="font-medium mb-2">Interactive Timeline</h4>
                                    <p class="text-sm text-gray-600 mb-4">Navigate through events chronologically. Click events for details.</p>
                                </div>
                                <div id="timeline-visualization" class="timeline-container"></div>
                                <div class="mt-4 grid grid-cols-3 gap-4 text-sm">
                                    <div class="bg-blue-50 p-3 rounded">
                                        <div class="font-medium text-blue-800">Events</div>
                                        <div class="text-2xl font-bold text-blue-600" x-text="result?.representation?.content?.stats?.event_count || 0"></div>
                                    </div>
                                    <div class="bg-green-50 p-3 rounded">
                                        <div class="font-medium text-green-800">Time Span</div>
                                        <div class="text-sm font-bold text-green-600" x-text="result?.representation?.content?.stats?.timeline_span || 'N/A'"></div>
                                    </div>
                                    <div class="bg-purple-50 p-3 rounded">
                                        <div class="font-medium text-purple-800">Period</div>
                                        <div class="text-xs font-medium text-purple-600">
                                            <span x-text="result?.representation?.content?.stats?.start_period"></span> - 
                                            <span x-text="result?.representation?.content?.stats?.end_period"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Summary -->
                            <div x-show="result?.mode === 'summary'">
                                <div class="bg-blue-50 rounded-lg p-4 mb-6 border-l-4 border-blue-500">
                                    <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                                        <i class="fas fa-bolt mr-2"></i>
                                        TL;DR
                                    </h4>
                                    <p class="text-blue-700" x-text="result?.representation?.content?.tldr"></p>
                                </div>
                                
                                <div class="space-y-4 mb-6">
                                    <h4 class="font-semibold flex items-center">
                                        <i class="fas fa-list mr-2 text-gray-600"></i>
                                        Key Points:
                                    </h4>
                                    <template x-for="(point, index) in result?.representation?.content?.key_points" :key="index">
                                        <div class="flex items-start bg-gray-50 p-3 rounded-lg">
                                            <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 mt-1">
                                                <span x-text="index + 1"></span>
                                            </div>
                                            <span x-text="point" class="flex-1"></span>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Main Topics -->
                                <div x-show="result?.representation?.content?.main_topics?.length > 0" class="mb-6">
                                    <h4 class="font-semibold mb-3 flex items-center">
                                        <i class="fas fa-tags mr-2 text-gray-600"></i>
                                        Main Topics:
                                    </h4>
                                    <div class="flex flex-wrap gap-2">
                                        <template x-for="topic in result?.representation?.content?.main_topics" :key="topic">
                                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium" x-text="topic"></span>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- Important Quotes -->
                                <div x-show="result?.representation?.content?.important_quotes?.length > 0">
                                    <h4 class="font-semibold mb-3 flex items-center">
                                        <i class="fas fa-quote-left mr-2 text-gray-600"></i>
                                        Key Insights:
                                    </h4>
                                    <div class="space-y-3">
                                        <template x-for="quote in result?.representation?.content?.important_quotes" :key="quote">
                                            <blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 bg-gray-50 p-3 rounded-r-lg">
                                                <span x-text="quote"></span>
                                            </blockquote>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Default/Other modes -->
                            <div x-show="!['plain_text', 'color_coded', 'collapsible_concepts', 'knowledge_graph', 'timeline', 'summary'].includes(result?.mode)">
                                <div class="prose max-w-none">
                                    <div x-html="result?.llm_response?.replace(/\n/g, '<br>')"></div>
                                </div>
                                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                                    <h4 class="font-semibold mb-2">Representation Data:</h4>
                                    <pre class="text-sm text-gray-700 overflow-auto" x-text="JSON.stringify(result?.representation, null, 2)"></pre>
                                </div>
                            </div>
                            
                            <!-- Feedback -->
                            <div class="mt-8 pt-6 border-t border-gray-200">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-semibold">How was this representation?</h4>
                                    <div class="flex space-x-2">
                                        <template x-for="star in [1,2,3,4,5]" :key="star">
                                            <button 
                                                @click="rating = star"
                                                :class="star <= rating ? 'text-yellow-400' : 'text-gray-300'"
                                                class="text-xl hover:text-yellow-400 transition-colors"
                                            >
                                                <i class="fas fa-star"></i>
                                            </button>
                                        </template>
                                    </div>
                                </div>
                                <div>
                                    <textarea 
                                        x-model="feedback"
                                        placeholder="Share your thoughts (optional)..."
                                        class="w-full h-16 p-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                    ></textarea>
                                    <button 
                                        @click="submitFeedback()"
                                        class="mt-2 px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors"
                                    >
                                        Submit Feedback
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-600">
            <div class="flex items-center justify-center space-x-6 mb-4">
                <a href="/admin" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-cog mr-1"></i>
                    Admin Panel
                </a>
                <a href="/health" class="text-green-600 hover:text-green-800">
                    <i class="fas fa-heart mr-1"></i>
                    System Health
                </a>
                <button @click="showSessionInfo = !showSessionInfo" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-info-circle mr-1"></i>
                    Session Info
                </button>
            </div>
            
            <!-- Session Info Modal -->
            <div x-show="showSessionInfo" x-transition class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showSessionInfo = false">
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Session Information</h3>
                    <div class="space-y-2 text-sm text-left">
                        <p><strong>Session ID:</strong> <span x-text="sessionId"></span></p>
                        <p><strong>Conversations:</strong> <span x-text="conversationCount"></span></p>
                        <p><strong>Total Tokens:</strong> <span x-text="totalTokens"></span></p>
                        <p><strong>Total Time:</strong> <span x-text="totalTime.toFixed(2)"></span>s</p>
                        <p><strong>Cache Hits:</strong> <span x-text="cacheHits"></span></p>
                    </div>
                    <button @click="showSessionInfo = false" class="mt-4 w-full bg-gray-600 text-white py-2 rounded hover:bg-gray-700">
                        Close
                    </button>
                </div>
            </div>
            
            <p class="text-sm">Powered by AI • Built with ❤️ for Knowledge Exploration • v2.0 with Smart Caching</p>
        </footer>
    </div>

    <script>
        function knowledgeApp() {
            return {
                // State
                query: '',
                context: '',
                selectedMode: 'plain_text',
                loading: false,
                result: null,
                error: null,
                rating: 0,
                feedback: '',
                sessionId: '',
                conversationCount: 0,
                totalTokens: 0,
                totalTime: 0,
                cacheHits: 0,
                showSessionInfo: false,
                forceRegenerate: false,
                
                // Visualization instances
                knowledgeNetwork: null,
                timelineVis: null,
                
                // Configuration
                representationModes: {
                    'plain_text': { name: 'Plain Text', icon: '📝', description: 'Simple, clean format' },
                    'color_coded': { name: 'Color-Coded', icon: '🎨', description: 'Tagged sections' },
                    'collapsible_concepts': { name: 'Concepts', icon: '🧩', description: 'Expandable tree' },
                    'knowledge_graph': { name: 'Graph', icon: '🧠', description: 'Visual network' },
                    'summary': { name: 'Summary', icon: '📦', description: 'Key points' },
                    'timeline': { name: 'Timeline', icon: '⏳', description: 'Chronological view' }
                },
                
                quickExamples: [
                    { query: 'Explain quantum computing', mode: 'knowledge_graph' },
                    { query: 'How does machine learning work?', mode: 'color_coded' },
                    { query: 'History of the internet', mode: 'timeline' },
                    { query: 'What is blockchain technology?', mode: 'collapsible_concepts' },
                    { query: 'Climate change impacts', mode: 'summary' }
                ],
                
                // Initialization
                init() {
                    this.sessionId = this.generateSessionId();
                    console.log('Knowledge Representation Engine v2.0 initialized');
                },
                
                // Methods
                async processQuery() {
                    if (!this.query.trim()) return;
                    
                    this.loading = true;
                    this.error = null;
                    this.result = null;
                    
                    // Clean up previous visualizations
                    this.cleanupVisualizations();
                    
                    try {
                        const requestData = {
                            query: this.query,
                            context: this.context ? { user_input: this.context } : null,
                            representation_mode: this.selectedMode,
                            user_preferences: {
                                visual_style: 'modern',
                                complexity_level: 'medium'
                            },
                            session_id: this.sessionId
                        };
                        
                        const url = this.forceRegenerate ? '/api/process?regenerate=true' : '/api/process';
                        
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestData)
                        });
                        
                        if (!response.ok) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                        
                        this.result = await response.json();
                        this.conversationCount++;
                        this.totalTokens += this.result.token_usage?.total_tokens || 0;
                        this.totalTime += this.result.processing_time || 0;
                        
                        // Track cache hits
                        if (this.result.metadata?.cache_info?.is_cached) {
                            this.cacheHits++;
                        }
                        
                        // Reset regenerate flag
                        this.forceRegenerate = false;
                        
                        // Initialize special visualizations after DOM update
                        await this.$nextTick();
                        if (this.result.mode === 'knowledge_graph') {
                            this.initializeKnowledgeGraph();
                        } else if (this.result.mode === 'timeline') {
                            this.initializeTimeline();
                        }
                        
                    } catch (err) {
                        this.error = err.message;
                        console.error('Error processing query:', err);
                    } finally {
                        this.loading = false;
                    }
                },
                
                initializeKnowledgeGraph() {
                    if (!this.result?.representation?.content?.graph_data) {
                        console.warn('No graph data available for knowledge graph');
                        return;
                    }
                    
                    const container = document.getElementById('knowledge-graph');
                    if (!container) {
                        console.warn('Knowledge graph container not found');
                        return;
                    }
                    
                    const data = this.result.representation.content.graph_data;
                    
                    const options = {
                        nodes: {
                            shape: 'dot',
                            size: 20,
                            font: { 
                                size: 14,
                                color: '#1F2937'
                            },
                            borderWidth: 2,
                            shadow: {
                                enabled: true,
                                color: 'rgba(0,0,0,0.2)',
                                size: 5,
                                x: 2,
                                y: 2
                            }
                        },
                        edges: {
                            width: 2,
                            shadow: {
                                enabled: true,
                                color: 'rgba(0,0,0,0.1)',
                                size: 3,
                                x: 1,
                                y: 1
                            },
                            smooth: { 
                                type: 'continuous',
                                roundness: 0.5
                            },
                            arrows: {
                                to: {
                                    enabled: true,
                                    scaleFactor: 0.8,
                                    type: 'arrow'
                                }
                            }
                        },
                        physics: {
                            enabled: true,
                            stabilization: { 
                                iterations: 100,
                                updateInterval: 25
                            },
                            barnesHut: {
                                gravitationalConstant: -8000,
                                centralGravity: 0.3,
                                springLength: 120,
                                springConstant: 0.04,
                                damping: 0.09,
                                avoidOverlap: 0.1
                            }
                        },
                        interaction: {
                            hover: true,
                            tooltipDelay: 200,
                            hideEdgesOnDrag: false,
                            hideNodesOnDrag: false
                        },
                        layout: {
                            improvedLayout: true,
                            clusterThreshold: 150
                        }
                    };
                    
                    try {
                        this.knowledgeNetwork = new vis.Network(container, data, options);
                        
                        // Add interaction handlers
                        this.knowledgeNetwork.on('click', (params) => {
                            if (params.nodes.length > 0) {
                                this.handleNodeClick(params.nodes[0], data);
                            }
                        });
                        
                        this.knowledgeNetwork.on('hoverNode', (params) => {
                            this.highlightConnectedNodes(params.node);
                        });
                        
                        this.knowledgeNetwork.on('blurNode', () => {
                            this.resetNodeHighlight();
                        });
                        
                        console.log('Knowledge graph initialized successfully');
                        
                    } catch (error) {
                        console.error('Error initializing knowledge graph:', error);
                        this.showError(container, 'Failed to load knowledge graph');
                    }
                },
                
                initializeTimeline() {
                    if (!this.result?.representation?.content?.events) {
                        console.warn('No timeline events available');
                        return;
                    }
                    
                    const container = document.getElementById('timeline-visualization');
                    if (!container) {
                        console.warn('Timeline container not found');
                        return;
                    }
                    
                    const events = this.result.representation.content.events;
                    
                    // Convert events to vis-timeline format
                    const items = new vis.DataSet(events.map((event, index) => ({
                        id: index,
                        content: `<div class="timeline-event-content">
                                    <div class="timeline-event-title">${event.title}</div>
                                    <div class="timeline-event-description">${event.description.substring(0, 100)}...</div>
                                  </div>`,
                        start: this.convertToDate(event.date_parsed),
                        type: 'point',
                        className: `timeline-event-${event.type}`,
                        title: event.description // Tooltip
                    })));
                    
                    const options = {
                        width: '100%',
                        height: '100%',
                        margin: {
                            item: 20,
                            axis: 40
                        },
                        orientation: 'top',
                        showCurrentTime: false,
                        zoomMin: 1000 * 60 * 60 * 24 * 30, // 30 days
                        zoomMax: 1000 * 60 * 60 * 24 * 365 * 100, // 100 years
                        editable: false,
                        selectable: true,
                        multiselect: false,
                        tooltip: {
                            followMouse: true,
                            overflowMethod: 'cap'
                        }
                    };
                    
                    try {
                        this.timelineVis = new vis.Timeline(container, items, options);
                        
                        // Add click handler
                        this.timelineVis.on('select', (params) => {
                            if (params.items.length > 0) {
                                const selectedEvent = events[params.items[0]];
                                this.showEventDetails(selectedEvent);
                            }
                        });
                        
                        console.log('Timeline initialized successfully');
                        
                    } catch (error) {
                        console.error('Error initializing timeline:', error);
                        this.showError(container, 'Failed to load timeline');
                    }
                },
                
                convertToDate(dateParsed) {
                    // Convert parsed date to JavaScript Date object
                    if (dateParsed.year) {
                        const year = dateParsed.year;
                        const month = dateParsed.month || 1;
                        const day = dateParsed.day || 1;
                        return new Date(year, month - 1, day);
                    }
                    return new Date();
                },
                
                handleNodeClick(nodeId, data) {
                    const node = data.nodes.find(n => n.id === nodeId);
                    if (node) {
                        alert(`Node: ${node.label}\nType: ${node.group}\nDescription: ${node.title}`);
                    }
                },
                
                showEventDetails(event) {
                    alert(`Event: ${event.title}\nDate: ${event.date_raw}\nType: ${event.type}\n\nDescription: ${event.description}`);
                },
                
                highlightConnectedNodes(nodeId) {
                    if (!this.knowledgeNetwork) return;
                    
                    const connectedNodes = this.knowledgeNetwork.getConnectedNodes(nodeId);
                    const connectedEdges = this.knowledgeNetwork.getConnectedEdges(nodeId);
                    
                    // Would implement highlighting logic here
                    console.log('Highlighting connected nodes:', connectedNodes);
                },
                
                resetNodeHighlight() {
                    // Would reset highlighting here
                    console.log('Resetting node highlight');
                },
                
                cleanupVisualizations() {
                    if (this.knowledgeNetwork) {
                        this.knowledgeNetwork.destroy();
                        this.knowledgeNetwork = null;
                    }
                    
                    if (this.timelineVis) {
                        this.timelineVis.destroy();
                        this.timelineVis = null;
                    }
                },
                
                showError(container, message) {
                    container.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center text-gray-500">
                                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                                <p>${message}</p>
                            </div>
                        </div>
                    `;
                },
                
                async handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    try {
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            this.context = result.content || JSON.stringify(result.data, null, 2);
                        }
                    } catch (err) {
                        console.error('File upload error:', err);
                    }
                },
                
                async submitFeedback() {
                    if (!this.result || this.rating === 0) return;
                    
                    try {
                        await fetch('/api/feedback', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                conversation_id: this.result.id,
                                session_id: this.sessionId,
                                rating: this.rating,
                                feedback_text: this.feedback,
                                representation_mode: this.result.mode
                            })
                        });
                        
                        this.rating = 0;
                        this.feedback = '';
                        alert('Thank you for your feedback!');
                    } catch (err) {
                        console.error('Feedback submission error:', err);
                    }
                },
                
                exportResult() {
                    if (!this.result) return;
                    
                    const data = {
                        query: this.query,
                        result: this.result,
                        timestamp: new Date().toISOString()
                    };
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `knowledge-representation-${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                },
                
                generateSessionId() {
                    return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                }
            }
        }
    </script>
</body>
</html>